<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shanghai Trip Expense Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.3s ease-out forwards; }
  </style>
</head>
<body class="bg-gradient-to-br from-red-50 to-red-200 text-gray-800 min-h-screen">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-center text-red-700">CN Trip Split Expense</h1>
        <div class="mb-6">
            <h2 class="text-xl font-bold mb-3 text-red-600">Name</h2>
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 mb-3">
                <input id="new-person-name" class="w-full border border-gray-300 rounded-lg p-2" placeholder="Add name" />
                <button id="add-person-btn" class="bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-700 transition whitespace-nowrap">Add Friend</button>
            </div>
            <div id="participants-list" class="flex flex-wrap gap-2"></div>
        </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-xl font-bold mb-4 text-red-600">Add Expense</h2>
      <form id="tx-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="col-span-2">
          <label class="block text-sm font-medium mb-1">What's this for?</label>
          <input id="desc" required class="w-full border border-gray-300 rounded-lg p-2" placeholder="e.g., HeyTea u laew!" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1"> Currency</label>
          <div class="flex gap-4 p-2">
            <label class="inline-flex items-center">
              <input type="radio" name="curr" value="CNY" checked class="form-radio text-red-600 focus:ring-red-500" /> <span class="ml-1">CNY</span>
            </label>
            <label class="inline-flex items-center">
              <input type="radio" name="curr" value="THB" class="form-radio text-red-600 focus:ring-red-500" /> <span class="ml-1">THB</span>
            </label>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">How much?</label>
          <input id="amt" type="number" step="0.01" required class="w-full border border-gray-300 rounded-lg p-2" />
        </div>
        <div class="col-span-2" id="rate-div">
          <label class="block text-sm font-medium mb-1"> Exchange Rate (1 CNY to THB)</label>
          <input id="rate" type="number" value="5.10" step="0.01" class="w-full border border-gray-300 rounded-lg p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1"> Who paid?</label>
          <select id="payer" class="w-full border border-gray-300 rounded-lg p-2" required></select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Split with who?</label>
          <div id="parts" class="grid grid-cols-2 sm:grid-cols-3 gap-2 border p-2 rounded-lg"></div>
        </div>
        <div class="col-span-2 text-right">
          <button type="submit" class="bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-700 transition">Add It!</button>
        </div>
      </form>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-lg mt-8">
      <h2 class="text-xl font-bold mb-4 text-red-600"> Expense List</h2>
      <div id="total-display" class="mb-4 text-lg font-semibold text-right">Total Spent: 0.00 THB</div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead>
            <tr class="bg-red-50">
                <th class="text-left p-3 font-semibold">Description</th>
                <th class="text-left p-3 font-semibold">Amount (THB)</th>
                <th class="text-left p-3 font-semibold">Paid By</th>
                <th class="text-left p-3 font-semibold">Shared With</th>
                <th class="text-center p-3 font-semibold">Actions</th>
            </tr>
            </thead>
            <tbody id="tbl" class="divide-y"></tbody>
        </table>
      </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-lg mt-8">
        <h2 class="text-xl font-bold mb-4 text-red-600"> What Everyone's Paid So Far</h2>
        <div id="paid-summary" class="space-y-2"></div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-lg mt-8">
      <h2 class="text-xl font-bold mb-4 text-red-600">Settle Up!</h2>
      <div class="text-center mb-4">
        <button id="calc" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition font-bold"> Let's Settle Up!</button>
      </div>
      <div id="summary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
  </div>

<script>
// --- STATE MANAGEMENT ---
const state = {
    people: [],
    transactions: [],
    exchangeRate: 5.10,
};

// --- DOM ELEMENT REFERENCES ---
const participantsList = document.getElementById('participants-list');
const addPersonBtn = document.getElementById('add-person-btn');
const newPersonNameInput = document.getElementById('new-person-name');
const payerSelect = document.getElementById('payer');
const partsDiv = document.getElementById('parts');
const txForm = document.getElementById('tx-form');
const transactionTableBody = document.getElementById('tbl');
const totalDisplay = document.getElementById('total-display');
const calculateBtn = document.getElementById('calc');
const summaryDiv = document.getElementById('summary');
const rateInput = document.getElementById('rate');
const currencyRadios = document.querySelectorAll('input[name="curr"]');
const paidSummaryDiv = document.getElementById('paid-summary');

// --- RENDER FUNCTIONS ---
function renderPeople() {
    participantsList.innerHTML = '';
    payerSelect.innerHTML = '<option value="">-- Select a friend --</option>';
    partsDiv.innerHTML = '';

    state.people.forEach((person, index) => {
        const personTag = document.createElement('div');
        personTag.className = 'flex items-center bg-red-100 text-red-800 text-sm font-semibold px-3 py-1 rounded-full fade-in';
        personTag.innerHTML = `
            <span>${person}</span>
            <button onclick="removePerson(${index})" class="ml-2 text-red-600 hover:text-red-900 font-bold"> &times; </button>
        `;
        participantsList.appendChild(personTag);

        const option = new Option(person, person);
        payerSelect.add(option);
        
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'flex items-center';
        checkboxDiv.innerHTML = `
            <input type="checkbox" id="person-${index}" value="${person}" checked class="form-checkbox h-4 w-4 text-red-600 rounded focus:ring-red-500">
            <label for="person-${index}" class="ml-2 text-sm">${person}</label>
        `;
        partsDiv.appendChild(checkboxDiv);
    });
    renderPaidSummary();
}

function renderTransactions() {
    transactionTableBody.innerHTML = '';
    let totalSpent = 0;

    state.transactions.forEach((tx, index) => {
        const row = transactionTableBody.insertRow();
        row.className = 'fade-in';
        // MODIFIED: Added clearer split calculation
        const share = tx.amountTHB / tx.participants.length;
        row.innerHTML = `
            <td class="p-3 align-top">${tx.description}</td>
            <td class="p-3 align-top">
                ${tx.amountTHB.toFixed(2)}
                <br>
                <small class="text-gray-500">(${tx.participants.length} people = ${share.toFixed(2)} each)</small>
            </td>
            <td class="p-3 align-top">${tx.payer}</td>
            <td class="p-3 align-top">${tx.participants.join(', ')}</td>
            <td class="p-3 text-center align-top">
                <button onclick="deleteTransaction(${index})" class="text-red-500 hover:text-red-700 font-bold">Delete</button>
            </td>
        `;
        totalSpent += tx.amountTHB;
    });

    totalDisplay.textContent = `Total Spent: ${totalSpent.toFixed(2)} THB`;
    summaryDiv.innerHTML = ''; 
    renderPaidSummary();
}

function renderPaidSummary() {
    paidSummaryDiv.innerHTML = '';
    const paidTotals = {};
    state.people.forEach(person => { paidTotals[person] = 0; });
    state.transactions.forEach(tx => {
        if (paidTotals.hasOwnProperty(tx.payer)) {
            paidTotals[tx.payer] += tx.amountTHB;
        }
    });

    if (state.people.length === 0) {
        paidSummaryDiv.innerHTML = '<p class="text-gray-500">Add friends to the crew to start!</p>';
        return;
    }

    for (const person in paidTotals) {
        const personDiv = document.createElement('div');
        personDiv.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg fade-in';
        personDiv.innerHTML = `
            <span class="font-semibold text-gray-800">${person}</span>
            <span class="font-bold text-red-700">${paidTotals[person].toFixed(2)} THB</span>
        `;
        paidSummaryDiv.appendChild(personDiv);
    }
}

function renderFinalSummary(settlements) {
    summaryDiv.innerHTML = '';
    if (settlements.length === 0) {
        summaryDiv.innerHTML = '<p class="text-center text-gray-500 col-span-full">ทุกคนเคลียร์กันเรียบร้อย! / Everyone is settled up! 🎉</p>';
        return;
    }
    settlements.forEach(text => {
        const p = document.createElement('p');
        p.className = 'bg-gray-100 p-3 rounded-lg text-center fade-in';
        p.innerHTML = text;
        summaryDiv.appendChild(p);
    });
}


// --- EVENT HANDLERS & LOGIC ---
function addPerson() {
    const name = newPersonNameInput.value.trim();
    if (name && !state.people.includes(name)) {
        state.people.push(name);
        newPersonNameInput.value = '';
        renderPeople();
    } else if (state.people.includes(name)) {
        alert('This friend is already in the crew!');
    }
}

function removePerson(index) {
    if(confirm(`Are you sure you want to remove ${state.people[index]} from the trip? This can't be undone.`)) {
      state.people.splice(index, 1);
      renderPeople();
      renderTransactions();
    }
}

function handleAddTransaction(event) {
    event.preventDefault();
    const description = document.getElementById('desc').value;
    const currency = document.querySelector('input[name="curr"]:checked').value;
    const amount = parseFloat(document.getElementById('amt').value);
    const payer = payerSelect.value;
    const participants = Array.from(partsDiv.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);

    if (!description || !amount || !payer || participants.length === 0) {
        alert('Hey, fill out all the fields and pick at least one friend to split with!');
        return;
    }

    const rate = parseFloat(rateInput.value);
    const amountTHB = currency === 'THB' ? amount : amount * rate;
    
    state.transactions.push({
        description, amountTHB, payer, participants,
    });
    
    renderTransactions();
    txForm.reset();
    partsDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
}

function deleteTransaction(index) {
    state.transactions.splice(index, 1);
    renderTransactions();
}

function calculateFinalSummary() {
    if (state.people.length < 2) {
        alert("You need at least two friends to settle up!");
        return;
    }
    const balances = state.people.reduce((acc, person) => ({ ...acc, [person]: 0 }), {});

    state.transactions.forEach(tx => {
        if(balances.hasOwnProperty(tx.payer)) balances[tx.payer] += tx.amountTHB;
        const share = tx.amountTHB / tx.participants.length;
        tx.participants.forEach(person => {
            if(balances.hasOwnProperty(person)) balances[person] -= share;
        });
    });

    const creditors = [];
    const debtors = [];
    for (const person in balances) {
        if (balances[person] > 0.01) {
            creditors.push({ name: person, amount: balances[person] });
        } else if (balances[person] < -0.01) {
            debtors.push({ name: person, amount: -balances[person] });
        }
    }
    
    creditors.sort((a, b) => b.amount - a.amount);
    debtors.sort((a, b) => b.amount - a.amount);

    const settlements = [];
    while (debtors.length > 0 && creditors.length > 0) {
        const debtor = debtors[0];
        const creditor = creditors[0];
        const amountToSettle = Math.min(debtor.amount, creditor.amount);

        settlements.push(`<b>${debtor.name}</b> pays <b>${creditor.name}</b> ➡️ <b>${amountToSettle.toFixed(2)} THB</b>`);

        debtor.amount -= amountToSettle;
        creditor.amount -= amountToSettle;

        if (debtor.amount < 0.01) debtors.shift();
        if (creditor.amount < 0.01) creditors.shift();
    }
    renderFinalSummary(settlements);
}


// --- INITIAL SETUP & EVENT LISTENERS ---
document.addEventListener('DOMContentLoaded', () => {
    addPersonBtn.addEventListener('click', addPerson);
    newPersonNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault(); // Prevents form submission
            addPerson();
        }
    });
    txForm.addEventListener('submit', handleAddTransaction);
    calculateBtn.addEventListener('click', calculateFinalSummary);
    currencyRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            document.getElementById('rate-div').style.display = (radio.value === 'CNY') ? 'block' : 'none';
        });
    });
    renderPeople();
    renderTransactions();
});
</script>
</body>
</html>